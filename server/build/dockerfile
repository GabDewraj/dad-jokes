FROM golang:1.19-alpine AS build_base

RUN apk add --no-cache git

# Set the Current Working Directory inside the container
RUN mkdir build
WORKDIR /build

# # Copy source directory
COPY . .
RUN go mod tidy
RUN go mod download


# Build the app
RUN go build -o server "./cmd/"


# Unit tests

# Second build with Artifact from the previous build
FROM alpine:3.9 
RUN apk add ca-certificates
ARG ENV
ENV ENV=${ENV}

COPY --from=build_base /build /app
COPY ./cmd/config/$ENV.yml ./config/$ENV.yml
COPY ./cmd/certificates/$ENV.crt ./certificates/$ENV.crt
COPY ./cmd/certificates/$ENV.key ./certificates/$ENV.key

# This container exposes port 9000 to the outside world
EXPOSE 8080
EXPOSE 8081

# Run the binary program produced by `go install`
CMD ["/app/server"]